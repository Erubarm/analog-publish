Часть 1: Виртуальные локальные сети (VLAN)

1.1. Что такое VLAN и зачем они нужны 

Исторически локальная сеть (LAN) охватывала небольшую территорию, например, одно здание, и обычно принадлежала одной организации. Однако по мере роста организаций возникла необходимость управлять сетевым трафиком более гибко.

**Определение:** Виртуальная локальная сеть (VLAN, Virtual Local Area Network) — это группа узлов сети, трафик которой (включая широковещательный) **полностью изолирован** от трафика других узлов сети на канальном уровне.

Проще говоря, VLAN позволяет разделить одну физическую коммутируемую сеть на несколько логически независимых сетей.

**Назначение и преимущества VLAN:**

1. **Отделение логической топологии от физической:** VLAN позволяют сетевому администратору создавать логические группы компьютеров (например, "Бухгалтерия", "Разработка", "Гостевая сеть"), независимо от того, к какому физическому коммутатору или порту они подключены.

2. **Сегментация широковещательного домена:** VLAN образует **домен широковещательного трафика**. В крупной сети широковещательный трафик (например, ARP-запросы) может быстро "затопить" всю сеть, если его не ограничить. VLAN предотвращает распространение широковещательных кадров за пределы своей группы (VLAN).

3. **Повышение безопасности и управляемости:** Поскольку трафик между разными VLAN изолирован на канальном уровне (Уровень 2 модели OSI), передача кадров между ними невозможна. Чтобы связать разные VLAN, необходимо использовать маршрутизаторы (Уровень 3). Это создает контролируемые барьеры на пути нежелательного трафика.

1.2. Механизм работы VLAN: Коммутаторы и фильтрация 

VLAN реализуются с помощью **VLAN-совместимых коммутаторов**.

• **Логика коммутатора:** Коммутатор, получив кадр, проверяет его идентификатор VLAN (VID).

• **Фильтрация:** Если таблица продвижения (MAC-адресов) говорит, что кадр нужно передать на определенный порт, коммутатор дополнительно проверяет, **соответствует ли VID кадра той VLAN, которая назначена этому порту**. Если соответствия нет, кадр отбрасывается.

• **Обучение MAC-адресов:** Коммутаторы изучают MAC-адреса **отдельно для каждой виртуальной локальной сети**. Например, если MAC-адрес A1 принадлежит VLAN 10, то этот адрес известен коммутатору только в контексте VLAN 10.

1.3. Стандартизация и формат кадра 

Для того чтобы коммутаторы могли распознавать, к какой VLAN принадлежит кадр, пришлось изменить традиционный формат кадра Ethernet.

• **Стандарт IEEE 802.1Q:** Был опубликован в 1998 году и ввел дополнительный заголовок — **тег VLAN**.

• **Тегированные и нетегированные кадры:** Кадр с тегом называется **помеченным (tagged frame)**. Коммутаторы могут работать как с помеченными, так и с непомеченными кадрами.

• **Изменение размера:** Добавление тега увеличило максимальный размер кадра Ethernet до **1522 байт**.

**Структура тега 802.1Q (4 байта):**

1. **VLAN Protocol ID (0x8100):** Двухбайтовое поле. Имеет фиксированное значение `0x8100`. Это значение было выбрано, чтобы старые сетевые карты Ethernet, которые не понимают VLAN, интерпретировали его как поле `Type` и, скорее всего, игнорировали бы кадр, поскольку значение `0x8100` превышает максимальную длину кадра (1500).

2. **Tag Control Information (TCI):** Второе двухбайтовое поле, содержащее вложенные поля:

    ◦ **VLAN Identifier (VID):** 12 бит. Это ключевое поле, содержащее идентификатор виртуальной сети. Позволяет создать до **4096** уникальных VLAN.

    ◦ **Priority (Приоритет):** 3 бита. Позволяет назначить кадру один из 8 классов приоритета, что используется для обеспечения качества обслуживания (QoS).

**Важный момент для программистов:** Теги VLAN используются в основном **только коммутаторами** и мостами. Если конечный компьютер несовместим с VLAN (или настроен не принимать теги), первый VLAN-совместимый коммутатор на пути кадра вставит тег, а последний — удалит его перед доставкой получателю.

1.4. Конфигурирование: Порты доступа и транки 

При настройке VLAN используется два основных типа линий связи (или портов коммутатора):

1. **Линия доступа (Access Line):** Соединяет порт коммутатора (порт доступа) с конечным устройством (ПК).

    ◦ Конечное устройство обычно работает с **нетегированными (untagged)** кадрами, то есть оно не знает о существовании VLAN.

    ◦ Порт доступа маркирует все входящие нетегированные кадры ID той единственной VLAN, к которой он приписан.

    ◦ Нетегированные кадры по умолчанию относятся к **Native VLAN** (обычно VLAN 1).

2. **Транк (Trunk):** Линия связи, соединяющая порты двух коммутаторов.

    ◦ Через транк передается трафик **нескольких виртуальных сетей**.

    ◦ Транковые порты **не добавляют и не удаляют теги**, а просто передают помеченные кадры в неизменном виде.

Конфигурирование VLAN может быть выполнено вручную или частично автоматизировано с помощью протоколов, таких как VTP (Cisco) или GVRP (IEEE).

Часть 2: Протокол покрывающего дерева (STP) 

2.1. Проблема петель в коммутируемых сетях

В современных сетях, построенных на коммутаторах (мостах), часто создаются избыточные физические связи. Это делается для обеспечения **отказоустойчивости** (если один кабель или коммутатор выйдет из строя, трафик пойдет по другому пути).

Однако избыточные связи приводят к образованию **петель (циклов)** в топологии.

**Петли катастрофичны для коммутируемой сети по двум причинам:**

1. **Широковещательные штормы (Broadcast Storms):** Если широковещательный кадр попадает в петлю, он начинает бесконечно циркулировать между коммутаторами. Коммутаторы многократно дублируют этот кадр. Сеть быстро "затапливается" этим трафиком, что делает ее неработоспособной.

2. **Нестабильность таблиц MAC-адресов:** Коммутаторы строят свои таблицы, изучая MAC-адреса источника. В сети с петлей кадр от одного и того же узла может прийти на один и тот же коммутатор через два разных порта. Коммутатор будет постоянно переписывать запись в своей таблице, связывая MAC-адрес с разными портами, что называется "мерцанием" MAC-адреса и нарушает нормальную доставку.

2.2. Назначение и принцип работы STP 

Для решения проблемы петель был разработан **Протокол покрывающего дерева (STP, Spanning Tree Protocol)**, стандартизированный как IEEE 802.1D.

• **Цель:** Логически устранить все циклы в сети, оставив только один активный путь между любыми двумя сегментами. STP преобразует физическую топологию, которая может содержать петли, в **логическую древовидную топологию** (покрывающее дерево).

• **Механизм:** STP переводит избыточные линии связи в **заблокированное состояние**. Эти связи находятся в "горячем резерве". Если активный путь выходит из строя, протокол STP автоматически активирует (переводит в состояние продвижения) заблокированный порт, восстанавливая связность.

**Ключевой недостаток классического STP:**

• **Избыточные связи не используются:** Блокированные связи используются только для резервирования, они не повышают общую производительность сети, поскольку по ним не передается пользовательский трафик.

• **Ограниченный контроль маршрутов:** Покрывающее дерево, построенное STP, является **общим для всех потоков** трафика, независимо от их адреса назначения или VLAN. Администратор имеет очень ограниченный контроль над выбором активных маршрутов.

2.3. Эволюция STP: RSTP и MSTP 

Классический STP, хотя и решал проблему петель, имел серьезные недостатки, связанные со скоростью сходимости.

1. **RSTP (Rapid Spanning Tree Protocol, IEEE 802.1w):**

    ◦ **Назначение:** Решить проблему **длительного времени сходимости** классического STP.

    ◦ **Ускорение:** RSTP значительно сокращает время перехода на новую активную топологию после отказа связи — с десятков секунд (50 секунд и более в STP) до **одной-двух секунд**.

    ◦ RSTP является более совершенной версией STP и широко применяется сегодня.

2. **MSTP (Multiple Spanning Tree Protocol, IEEE 802.1s):**

    ◦ **Назначение:** Решить проблему **неоптимальности маршрутов** и неиспользования избыточных связей.

    ◦ **Механизм:** Вместо одного общего покрывающего дерева, MSTP позволяет создавать **несколько покрывающих деревьев** в одной физической сети.

    ◦ Администратор может **приписать разные VLAN к разным деревьям** (или группам деревьев).

    ◦ **Преимущество:** Это позволяет балансировать нагрузку (например, трафик VLAN 10 идет через коммутатор A, а трафик VLAN 20 — через коммутатор B), тем самым используя все имеющиеся физические связи и повышая общую производительность сети. MSTP основан на RSTP, поэтому он также обеспечивает быструю реакцию на отказы.

2.4. Итог: Отказоустойчивость Layer 2 

Технологии STP (и его современные версии RSTP/MSTP) являются обязательными элементами для создания надежных коммутируемых сетей, которые требуют резервирования путей, но при этом должны избежать катастрофических последствий широковещательных штормов, вызванных петлями.

Хотя STP, RSTP и MSTP обеспечивают отказоустойчивость, они предоставляют лишь ограниченный контроль над маршрутизацией трафика на уровне 2. Более современные подходы к маршрутизации на канальном уровне, такие как SPBM (Shortest Path Bridging), стремятся использовать протоколы маршрутизации, учитывающие состояние связей (подобные OSPF или IS-IS, о которых мы говорили на предыдущих лекциях), для достижения более рациональных маршрутов и быстрой сходимости.

--------------------------------------------------------------------------------