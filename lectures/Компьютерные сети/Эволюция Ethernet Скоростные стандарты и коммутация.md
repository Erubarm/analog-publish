Часть 1: Виртуальные локальные сети (VLAN)

1.1. Определение и назначение VLAN 

• **Определение:** Виртуальная локальная сеть (VLAN) – это группа узлов сети, трафик которой (включая широковещательный) полностью изолирован от трафика других узлов сети на канальном уровне.

• VLAN позволяют отделить физическую топологию сети от логической.

• Назначение VLAN состоит в том, чтобы облегчить процесс создания изолированных сетей, которые затем обычно связываются между собой с помощью маршрутизаторов.

• VLAN образуют **домен широковещательного трафика**. Это критически важно, поскольку любое крупное корпоративное построение сети должно включать маршрутизаторы, чтобы потоки ошибочных (например, широковещательных) кадров не «затопляли» всю сеть через прозрачные коммутаторы.

1.2. Механизм работы VLAN на коммутаторах

• Коммутаторы, совместимые с VLAN, используются для создания виртуальных сетей.

• Коммутаторы поддерживают дополнительную фильтрацию трафика: если таблица продвижения говорит о том, что пришедший кадр нужно передать на порт, коммутатор проверяет, соответствует ли значение VID (VLAN Identifier) в теге VLAN кадра той виртуальной локальной сети, которая приписана к этому порту. Если соответствия нет, кадр отбрасывается.

• MAC-адреса изучаются коммутаторами отдельно для каждой виртуальной локальной сети.

1.3. Стандарт IEEE 802.1Q и формат кадра

• Для реализации VLAN необходима схема, по которой мосты (коммутаторы) будут знать, к какой VLAN принадлежит входящий фрейм.

• Стандарт **IEEE 802.1Q** (опубликован в 1998 году) изменил формат заголовка кадра Ethernet, введя дополнительный заголовок – **тег VLAN**.

• Тег VLAN не является обязательным, кадр с тегом называют **помеченным (tagged frame)**. Коммутаторы могут работать как с помеченными, так и с непомеченными кадрами.

• Из-за добавления тега максимальная длина Ethernet-фрейма была повышена до **1522 байт**.

• **Структура тега 802.1Q**:

   ◦ **VLAN Protocol ID (0x8100):** Двухбайтовое поле, всегда имеет значение `0x8100`. Поскольку это значение превышает 1500, старые сетевые карты Ethernet интерпретируют его как `Type`.

   ◦ **Tag Control Information (TCI):** Второе двухбайтовое поле, содержащее вложенные поля:

   ▪ **Priority (Приоритет):** Трехбитовое поле. Позволяет различать 8 классов трафика для улучшения показателей QoS (например, трафик жесткого/мягкого реального времени).

   ▪ **CFI (Canonical Format Indicator):** Однобитовое поле, должно быть равно 0 для сетей Ethernet (изначально предназначалось для поддержки формата Token Ring).

   ▪ **VLAN Identifier (VID):** 12 младших битов. Содержит идентификатор виртуальной сети, что позволяет создавать до **4096** виртуальных сетей.

• **Как используется тег:** Поля VLAN реально используются только мостами и коммутаторами, а не компьютерами пользователей. Первый VLAN-совместимый мост вставляет это поле, а последний — удаляет его (если конечный узел несовместим с VLAN).

1.4. Типы портов и конфигурирование VLAN

• Наиболее распространен подход к конфигурированию VLAN, основанный на понятиях **линии доступа** и **транка**.

• **Линия доступа (Access Line):** Связывает порт коммутатора (порт доступа) с конечным узлом (компьютером), который принадлежит некоторой VLAN. Конечный узел, как правило, работает с **непомеченными (untagged) кадрами**, т.е. структура VLAN для него прозрачна.

   ◦ _Назначение VLAN по умолчанию (Native VLAN):_ Если кадр непомеченный, он обрабатывается как принадлежащий условной сети **VLAN1** (или другой, назначенной администратором).

• **Транк (Trunk):** Это линия связи, которая соединяет между собой порты двух коммутаторов; через транк передается трафик **нескольких виртуальных сетей**. Порты, подключенные к транкам, не добавляют и не удаляют теги, а просто передают помеченные кадры в неизменном виде.

• **Способы конфигурирования VLAN:**

   ◦ Вручную: Администратор решает, сколько будет VLAN, какие компьютеры в них войдут и назначает им имена (часто обозначаются цветами).

   ◦ Автоматизация: Существуют протоколы, такие как фирменный протокол Cisco **VLAN Trunking Protocol (VTP)** или стандартный **GARP VLAN Registration Protocol (GVRP)**, которые позволяют коммутаторам обмениваться информацией об активизированных VLAN по транковым связям.

• **Пример: Логическая сегментация сети.** VLAN позволяют обеспечить изоляцию. Например, можно организовать две VLAN, VLAN2 и VLAN3, приписав один набор компьютеров и серверов к VLAN2, а другой — к VLAN3. Трафик между ними будет изолирован на канальном уровне.

--------------------------------------------------------------------------------

Часть 2: Протокол STP (Spanning Tree Protocol) 

2.1. Необходимость STP и проблема петель 

• Для объединения нескольких физических LAN в одну логическую сеть используются мосты (коммутаторы).

• Если коммутаторы соединены непроизвольно, могут возникнуть **циклы (петли)**. В сетях Ethernet, где используется широковещание, петли приводят к тому, что широковещательный трафик начинает бесконечно циркулировать, «затапливая» всю сеть и делая ее неработоспособной.

• Для устранения циклов применяется **алгоритм связующего дерева** (Spanning Tree Protocol, STP).

• **Цель STP:** Построение логической топологии в виде дерева (покрывающего дерева) поверх физической топологии, которая может содержать избыточные связи (петли).

2.2. Принцип работы STP

• Протокол STP обеспечивает надежность, прерывая циклы, которые могут возникнуть при непроизвольном соединении коммутаторов.

• STP функционирует на канальном уровне (уровень 2 модели OSI).

• **Общий механизм:** Протокол STP оставляет в рабочем состоянии только те линии связи, которые не образуют циклов, переводя остальные линии в блокированное состояние. При отказе активной связи STP активирует заблокированный путь, восстанавливая связность.

• Протокол покрывающего дерева (STP) дает администратору сети очень **ограниченный контроль** над выбором маршрута.

• Покрывающее дерево, построенное STP, является **общим для всех потоков**, независимо от их адреса назначения.

2.3. Недостатки и эволюция STP: RSTP и MSTP

• **Ограничения классического STP:**

   ◦ **Длительное время установления:** Классический STP имеет длительное время сходимости (установления новой активной топологии), измеряемое десятками секунд. Это очень медленно по сравнению с требованиями магистральных сетей (например, SDH, где переключение происходит за десятки миллисекунд).

   ◦ **Неоптимальность маршрутов:** Поскольку дерево общее для всех потоков, маршруты могут быть неоптимальными для части трафика.

• **Rapid Spanning Tree Protocol (RSTP):**

   ◦ Протокол RSTP (Быстрый STP) находит покрывающее дерево значительно быстрее, чем классический STP. Время переключения сокращается с десятков секунд до **одной-двух секунд**.

   ◦ RSTP является более совершенной версией STP.

• **Multiple Spanning Tree Protocol (MSTP):**

   ◦ MSTP (Протокол нескольких покрывающих деревьев) был разработан для преодоления неоптимальности маршрутов, присущей STP/RSTP.

   ◦ MSTP позволяет построить **отдельное дерево для каждой магистральной сети VLAN (B-VLAN)**.

   ◦ Например, можно настроить, что сеть VLAN100 приписана к покрывающему дереву с корневым коммутатором 111, а VLAN200 — к дереву с корневым коммутатором 222.

   ◦ Такой подход позволяет использовать все коммутаторы сети для передачи трафика, что повышает общую производительность.

   ◦ Протокол MSTP основан на RSTP и обеспечивает быструю реакцию сети на отказы.

• **Дальнейшее развитие:** Существуют более современные протоколы, такие как **SPBM** (Shortest Path Bridging) (IEEE 802.1aq), который использует протокол маршрутизации IS-IS и обеспечивает более рациональные маршруты и быструю перестройку активной топологии, подобно сетям IP